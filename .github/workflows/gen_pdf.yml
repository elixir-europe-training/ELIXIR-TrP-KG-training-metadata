name: Generate PDF
on:
  push:
    branches: [ main, feature/optimise-doc ]
jobs:
  gen-pdf:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: biohackathon name given?
      run: |
        sed -n '/^---$/,/^---$/{//b;p}' paper/paper.md | grep biohackathon_name
    - name: biohackathon location given?
      run: |
        sed -n '/^---$/,/^---$/{//b;p}' paper/paper.md | grep biohackathon_location
    - name: biohackathon url given?
      run: |
        sed -n '/^---$/,/^---$/{//b;p}' paper/paper.md | grep biohackathon_url
    - name: Git repository given?
      run: |
        sed -n '/^---$/,/^---$/{//b;p}' paper/paper.md | grep git_url
    - name: Setup Node.js (for Mermaid CLI)
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Install Mermaid CLI
      run: npm i -g @mermaid-js/mermaid-cli
    - name: Install pdfcrop (for trimming PDF margins)
      run: sudo apt-get update && sudo apt-get install -y texlive-extra-utils
    - name: Render and crop Mermaid diagrams
      shell: bash
      run: |
          set -euo pipefail
          echo '{ "args": ["--no-sandbox","--disable-setuid-sandbox"] }' > puppeteer-config.json
          shopt -s globstar nullglob
              
          found=false
          for f in paper/diagrams/**/*.mmd paper/diagrams/*.mmd; do
            [ -e "$f" ] || continue
            found=true
            base="${f%.*}"
            echo "Rendering $f -> ${base}.pdf"
            mmdc -p puppeteer-config.json -i "$f" -o "${base}.pdf" --pdfFit --scale 1.2
            echo "Cropping ${base}.pdf -> ${base}.cropped.pdf"
            pdfcrop "${base}.pdf" "${base}.cropped.pdf" >/dev/null
          done
              
          if [ "$found" = false ]; then
            echo "No .mmd files found under paper/diagrams/, skipping render."
          fi
    - uses: kohlerdominik/docker-run-action@v2.0.0
      with:
        image: ghcr.io/biohackrxiv/bhxiv-gen-pdf:master
        volumes: ${{ github.workspace }}:/work
        workdir: /work
        run: |
          gen-pdf paper
    - name: Create info file
      run: |
         echo -e "ref: $GITHUB_REF \ncommit: $GITHUB_SHA\nbuild: $(date +"%Y-%m-%dT%H:%M:%SZ")" \
         > info.txt
    - name: Upload generated PDF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: PDF and info.txt
        path: |
          paper/paper.pdf
          info.txt